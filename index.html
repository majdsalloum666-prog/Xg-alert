<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>xG Alert â€“ Live Stats</title>
  <style>
    body { font-family: Arial; text-align:center; padding-top:20px; }
    #enableSoundBtn { font-size:18px; padding:10px 20px; margin-bottom:10px; }
    #status { margin:10px 0; color:#555; }
    #alertBox {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.9); color:#fff; z-index:9999;
      align-items:center; justify-content:center; flex-direction:column;
    }
    #alertBox h1 { font-size:26px; margin-bottom:8px; }
    #alertBox p { font-size:18px; white-space:pre-line; }
    #closeBtn { margin-top:16px; font-size:18px; padding:8px 20px; }
  </style>
</head>
<body>

<h2>xG Alert (Live)</h2>
<p>ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¶ØºØ· Ù‡Ø¬ÙˆÙ…ÙŠ Ù‚ÙˆÙŠ</p>

<button id="enableSoundBtn">ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª (Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©)</button>
<div id="status">Ø§Ù„Ø­Ø§Ù„Ø©: Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</div>

<div id="alertBox">
  <h1>âš½ xG ALERT</h1>
  <p id="alertText"></p>
  <button id="closeBtn">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<audio id="alarmSound">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
</audio>

<script>
  // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =====
  const MIN_MINUTE = 30;
  const MIN_XG = 1.5;
  const CHECK_EVERY_MS = 30000; // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
  let alerted = false;
  let soundEnabled = false;

  const sound = document.getElementById("alarmSound");
  const alertBox = document.getElementById("alertBox");
  const alertText = document.getElementById("alertText");
  const statusEl = document.getElementById("status");
  const enableSoundBtn = document.getElementById("enableSoundBtn");

  // ===== ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù„Ø§Ø²Ù… Ø¨Ø¹Ø¯ ÙƒÙ„ ÙØªØ­ ØµÙØ­Ø©) =====
  enableSoundBtn.onclick = () => {
    sound.play().then(() => {
      sound.pause(); sound.currentTime = 0;
      soundEnabled = true;
      statusEl.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù‘Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©";
      alert("âœ… Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù‘Ù„");
    });
  };

  // ===== Ø­Ø³Ø§Ø¨ xG Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ =====
  function calcXG(shotsOnTarget, dangerousAttacks) {
    return (shotsOnTarget * 0.35) + (dangerousAttacks / 25);
  }

  // ===== Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­ÙŠÙ‘Ø© (Ù…Ø«Ø§Ù„ Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ§Ø­Ø¯Ø©) =====
  async function fetchLiveStats() {
    // Ù…Ø«Ø§Ù„ Endpoint Ø¹Ø§Ù… Ø¹Ø¨Ø± ÙˆØ³ÙŠØ· CORS (Ù‚Ø¯ ÙŠØªØºÙŠØ±)
    // ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù€ URL Ù„Ù…ØµØ¯Ø± Ø¢Ø®Ø± Ù…Ù…Ø§Ø«Ù„
    const url = "https://api.allorigins.win/raw?url=https://www.sofascore.com/api/v1/sport/football/events/live";
    const res = await fetch(url);
    const data = await res.json();
    return data.events || [];
  }

  async function checkMatches() {
    if (alerted) return;

    try {
      const events = await fetchLiveStats();
      statusEl.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ­Øµ ${events.length} Ù…Ø¨Ø§Ø±Ø§Ø© Ø­ÙŠÙ‘Ø©`;

      for (const ev of events) {
        // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        if (!ev.statistics) continue;

        const minute = ev.time?.current || 0;

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø³Ø§Ø³ÙŠØ© (Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­)
        const homeSOT = ev.statistics.home?.shotsOnTarget ?? 0;
        const awaySOT = ev.statistics.away?.shotsOnTarget ?? 0;
        const homeDA  = ev.statistics.home?.dangerousAttacks ?? 0;
        const awayDA  = ev.statistics.away?.dangerousAttacks ?? 0;

        const xgHome = calcXG(homeSOT, homeDA);
        const xgAway = calcXG(awaySOT, awayDA);
        const totalXG = xgHome + xgAway;

        if (minute >= MIN_MINUTE && totalXG >= MIN_XG) {
          alerted = true;

          alertText.innerText =
            `${ev.homeTeam?.name} vs ${ev.awayTeam?.name}\n` +
            `Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©: ${minute}\n` +
            `xG Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„: ${xgHome.toFixed(2)}\n` +
            `xG Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ: ${xgAway.toFixed(2)}\n` +
            `xG Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalXG.toFixed(2)}`;

          alertBox.style.display = "flex";
          if (soundEnabled) sound.play();
          break;
        }
      }
    } catch (e) {
      statusEl.textContent = "Ø§Ù„Ø­Ø§Ù„Ø©: Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©)";
      console.error(e);
    }
  }

  // ØªØ´ØºÙŠÙ„ Ø¯ÙˆØ±ÙŠ
  setInterval(checkMatches, CHECK_EVERY_MS);

  document.getElementById("closeBtn").onclick = () => {
    alertBox.style.display = "none";
    sound.pause(); sound.currentTime = 0;
  };
</script>

</body>
</html>
